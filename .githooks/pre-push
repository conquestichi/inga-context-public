#!/usr/bin/env bash
set -euo pipefail

# ==== settings ====
INK_ENV=${INK_ENV:-/root/inkaritsu/config/inkaritsu.env}
HEALTH=/root/bin/ink_webhook_health.sh
CLI=/root/bin/ink_place_cli.sh
TIMEOUT_HEALTH=15s
TIMEOUT_DRYRUN=15s
SYMBOL=${INK_PREPUSH_SYMBOL:-6501.T}
QTY=${INK_PREPUSH_QTY:-1}
SRC=${INK_PREPUSH_SOURCE:-prepush}
CANCEL_ID="prepush-$(date +%s)"

# スキップ用（必要なときだけ）
if [[ -n "${SKIP_PREPUSH:-}" ]]; then
  echo "[pre-push] skipped (SKIP_PREPUSH=1)"
  exit 0
fi

timeout_exists() { command -v timeout >/dev/null 2>&1; }
run_to() {                     # run_to <timeout> <cmd...>
  if timeout_exists; then timeout "$1" "${@:2}"; else "${@:2}"; fi
}

ok=1

# 1) health（短時間・静音）
if ! run_to "$TIMEOUT_HEALTH" env ENV="$INK_ENV" "$HEALTH" >/dev/null 2>&1; then
  echo "[pre-push] health failed"
  ok=0
fi

# 2) dry-run（詳細ログ）
tmp="$(mktemp)"; trap 'rm -f "$tmp"' EXIT
if ! run_to "$TIMEOUT_DRYRUN" env ENV="$INK_ENV" "$CLI" \
      --action buy --symbol "$SYMBOL" --qty "$QTY" \
      --source "$SRC" --dry true --cancel-id "$CANCEL_ID" >"$tmp" 2>&1; then
  echo "[pre-push] dry-run failed"
  sed -n '1,120p' "$tmp" >&2   # 失敗時だけ先頭ログを出す
  ok=0
else
  sig=$(sed -n 's/.*"signal":[[:space:]]*\([0-9][0-9]*\).*/\1/p' "$tmp" | head -1 || true)
  wdv=$(sed -n 's/.*"webhook_dev":[[:space:]]*\([0-9][0-9]*\).*/\1/p' "$tmp" | head -1 || true)
  web=$(sed -n 's/.*"webhook":[[:space:]]*\([0-9][0-9]*\).*/\1/p' "$tmp" | head -1 || true)
  echo "[pre-push] codes: signal=${sig:-?} webhook_dev=${wdv:-?} webhook=${web:-?}"
fi

if [[ $ok -eq 1 ]]; then
  echo "[pre-push] OK"
  exit 0
fi

echo "[pre-push] DENY"
exit 1
